<!DOCTYPE html><html lang="en" class="no-js">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity - Manual:  Low-level Native Plugin Interface</title>
<meta name="description" content="The Unity Manual helps you learn and use the Unity engine. With the Unity engine you can create 2D and 3D games, apps and experiences.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFilesManual/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFilesManual/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFilesManual/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFilesManual/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFilesManual/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFilesManual/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFilesManual/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFilesManual/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFilesManual/images/favicons/tileicon-144x144.png">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2854981-1']);
  _gaq.push(['_setDomainName', 'unity3d.com']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script><script type="text/javascript" src="../StaticFilesManual/js/jquery.js?ts=1492779482"></script><script type="text/javascript" src="../StaticFilesManual/js/core.js?ts=1492779482"></script><script type="text/javascript" src="docdata/toc.js?ts=1492779482"></script><script type="text/javascript" src="docdata/global_toc.js?ts=1492779482"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFilesManual/css/core.css?ts=1492779482">
</head>
<body>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul>
<li><a href="../Manual/index.html" class="selected">Manual</a></li>
<li><a href="../ScriptReference/index.html">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="http://unity3d.com/">unity3d.com</a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-number">Version: <b>5.6</b> (<a href="https://docs.unity3d.com/2017.1/Documentation/Manual">switch to 2017.1b</a>)</div>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language: <span class="b">English</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/NativePluginInterface.html">English</a></li>
<li><a href="/ja/current/Manual/NativePluginInterface.html">日本語</a></li>
<li><a href="/es/current/Manual/NativePluginInterface.html">Español</a></li>
<li><a href="/kr/current/Manual/NativePluginInterface.html">한국어</a></li>
<li><a href="/ru/current/Manual/NativePluginInterface.html">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc"><h2>Unity Manual</h2></div></div></div></div></div>
<div id="content-wrap" class="content-wrap"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (5.6)</a></li>
<li><a href="UnityOverview.html">Working In Unity</a></li>
<li><a href="AdvancedDevelopment.html">Advanced Development</a></li>
<li><a href="Plugins.html">Plugins</a></li>
<li> Low-level Native Plugin Interface</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="PluginsForDesktop.html"></a></span><div class="tip">Building Plugins for Desktop Platforms</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="AssetBundlesIntro.html"></a></span><div class="tip">Asset Bundles</div>
</div>
</div></div>
<h1>Low-level Native Plugin Interface</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>In addition to the basic script interface, <a href="Plugins.html">Native Code Plugins</a> in Unity can receive callbacks when certain events happen. This is mostly used to implement low-level rendering in your plugin and enable it to work with Unity’s multithreaded rendering.</p>

<p>Headers defining interfaces exposed by Unity are provided with the editor.</p>

<h2>Interface Registry</h2>

<p>A plugin should export <code>UnityPluginLoad</code> and <code>UnityPluginUnload</code> functions to handle main Unity events. See <code>IUnityInterface.h</code> for the correct signatures. <code>IUnityInterfaces</code> is provided to the plugin to access further Unity APIs.</p>

<pre><code>#include &quot;IUnityInterface.h&quot;
#include &quot;IUnityGraphics.h&quot;
// Unity plugin load event
extern &quot;C&quot; void UNITY_INTERFACE_EXPORT UNITY_INTERFACE_API
    UnityPluginLoad(IUnityInterfaces* unityInterfaces)
{
    IUnityGraphics* graphics = unityInterfaces-&gt;Get&lt;IUnityGraphics&gt;();
}
</code></pre>

<h2>Access to the Graphics Device</h2>

<p>A plugin can access generic graphics device functionality by getting the <code>IUnityGraphics</code> interface. In earlier versions of Unity a <code>UnitySetGraphicsDevice</code> function had to be exported in order to receive notification about events on the graphics device. Starting with Unity 5.2 the new IUnityGraphics interface (found in <code>IUnityGraphics.h</code>) provides a way to register a callback.</p>

<pre><code>#include &quot;IUnityInterface.h&quot;
#include &quot;IUnityGraphics.h&quot;
    
static IUnityInterfaces* s_UnityInterfaces = NULL;
static IUnityGraphics* s_Graphics = NULL;
static UnityGfxRenderer s_RendererType = kUnityGfxRendererNull;
    
// Unity plugin load event
extern &quot;C&quot; void UNITY_INTERFACE_EXPORT UNITY_INTERFACE_API
    UnityPluginLoad(IUnityInterfaces* unityInterfaces)
{
    s_UnityInterfaces = unityInterfaces;
    s_Graphics = unityInterfaces-&gt;Get&lt;IUnityGraphics&gt;();
        
    s_Graphics-&gt;RegisterDeviceEventCallback(OnGraphicsDeviceEvent);
        
    // Run OnGraphicsDeviceEvent(initialize) manually on plugin load
    // to not miss the event in case the graphics device is already initialized
    OnGraphicsDeviceEvent(kUnityGfxDeviceEventInitialize);
}
    
// Unity plugin unload event
extern &quot;C&quot; void UNITY_INTERFACE_EXPORT UNITY_INTERFACE_API
    UnityPluginUnload()
{
    s_Graphics-&gt;UnregisterDeviceEventCallback(OnGraphicsDeviceEvent);
}
    
static void UNITY_INTERFACE_API
    OnGraphicsDeviceEvent(UnityGfxDeviceEventType eventType)
{
    switch (eventType)
    {
        case kUnityGfxDeviceEventInitialize:
        {
            s_RendererType = s_Graphics-&gt;GetRenderer();
            //TODO: user initialization code
            break;
        }
        case kUnityGfxDeviceEventShutdown:
        {
            s_RendererType = kUnityGfxRendererNull;
            //TODO: user shutdown code
            break;
        }
        case kUnityGfxDeviceEventBeforeReset:
        {
            //TODO: user Direct3D 9 code
            break;
        }
        case kUnityGfxDeviceEventAfterReset:
        {
            //TODO: user Direct3D 9 code
            break;
        }
    };
}
</code></pre>

<h2>Plugin Callbacks on the Rendering Thread</h2>

<p>Rendering in Unity can be multithreaded if the platform and number of available CPUs will allow for it. When multithreaded rendering is used, the rendering API commands happen on a thread which is completely separate from the one that runs MonoBehaviour scripts. Consequently, it is not always possible for your plugin to start doing some rendering immediately, because it might interfere with whatever the render thread is doing at the time.</p>

<p>In order to do <strong>any</strong> rendering from the plugin, you should call <a href="../ScriptReference/GL.IssuePluginEvent.html">GL.IssuePluginEvent</a> from your script. This will cause the provided native function to be called from the render thread. For example, if you call GL.IssuePluginEvent from the camera’s OnPostRender function, you get a plugin callback immediately after the camera has finished rendering.</p>

<p>Signature for the <code>UnityRenderingEvent</code> callback is provided in <code>IUnityGraphics.h</code>.
Native plugin code example:</p>

<pre><code>// Plugin function to handle a specific rendering event
static void UNITY_INTERFACE_API OnRenderEvent(int eventID)
{
    //TODO: user rendering code
}
    
// Freely defined function to pass a callback to plugin-specific scripts
extern &quot;C&quot; UnityRenderingEvent UNITY_INTERFACE_EXPORT UNITY_INTERFACE_API
    GetRenderEventFunc()
{
    return OnRenderEvent;
}
</code></pre>

<p>Managed plugin code example:</p>

<pre><code>#if UNITY_IPHONE &amp;&amp; !UNITY_EDITOR
[DllImport (&quot;__Internal&quot;)]
#else
[DllImport(&quot;RenderingPlugin&quot;)]
#endif
private static extern IntPtr GetRenderEventFunc();
    
// Queue a specific callback to be called on the render thread
GL.IssuePluginEvent(GetRenderEventFunc(), 1);
</code></pre>

<p>Such callbacks can now also be added to CommandBuffers via <a href="../ScriptReference/Rendering.CommandBuffer.IssuePluginEvent.html">CommandBuffer.IssuePluginEvent</a>.</p>

<h2>Example</h2>

<p>An example of a low-level rendering plugin is on bitbucket: <strong><a href="https://bitbucket.org/Unity-Technologies/graphicsdemos">bitbucket.org/Unity-Technologies/graphicsdemos</a></strong> (NativeRenderingPlugin folder). It demonstrates two things:</p>

<ul>
<li>Renders a rotating triangle from C++ code after all regular rendering is done.</li>
<li>Fills a procedural texture from C++ code, using Texture.GetNativeTexturePtr to access it.</li>
</ul>

<p>The project works with:</p>

<ul>
<li>Windows (Visual Studio 2015) with Direct3D 9, Direct3D 11, Direct3D 12 and OpenGL.</li>
<li>Mac OS X (Xcode) with Metal and OpenGL.</li>
<li>Windows Store Apps (Windows 10 and Windows 8.1 flavors) with Direct3D 11 and Direct3D 12.</li>
<li>WebGL</li>
</ul>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="PluginsForDesktop.html"></a></span><div class="tip">Building Plugins for Desktop Platforms</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="AssetBundlesIntro.html"></a></span><div class="tip">Asset Bundles</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">
<known_issues><p>Is something described here not working as you expect it to? It might be a <b>Known Issue</b>. Please check with the Issue Tracker at <a href="http://issuetracker.unity3d.com">issuetracker.unity3d.com</a>.</p></known_issues>Copyright © 2017 Unity Technologies. Publication: 5.6-001I. Built: 2017-04-21.</div>
<div class="menu">
<a href="http://unity3d.com/learn">Tutorials</a><a href="http://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="http://forum.unity3d.com">Forums</a><a href="http://unity3d.com/asset-store">Asset Store</a>
</div>
</div></div>
</div></div></div>
</div>
<noscript><iframe src="http://www.googletagmanager.com/ns.html?id=GTM-MC35ML" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'http://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MC35ML');</script>
</body>
</html>
